---
title: 카프카, 데이터 플랫폼의 최강자 4장
date: 2025-03-23
update: 2025-03-23
tags: 
    - kafka
---

# 4장 카프카 프로듀서
카프카의 토픽으로 메세지를 보내는 역할을 수행하는 애플리케이션, 서버 등을 모두 프로듀서라고 한다.
주요 기능은 각 메시를 토픽 파티션에 매핑하고 파티션의 리더에 요청을 보내는 것
키 값을 정해 해당 키를 가진 모든 메시지를 동일한 파티션으로 전송할 수 있음
키 값이 없다면 파티션은 라운드 로빈으로 파티션에 균등하게 분배됨

## 4.2 자바와 파이썬을 이용한 프로듀서
코드로 설명한 부분이 있지만 코드보다는 개념적으로 정리할 내용에 대해서 작성합니다.
프로듀서에서 메시지를 보내는 3가지 방식

### 4.2.1 메세지를 보내고 확인하지 않기
프로듀서가 서버로 메시지를 보내고 난 후에 성공적으로 도착했는지까지 확인하지는 않습니다.

### 4.2.2 동기 전송
메시지를 보내고 전송이 성공했는지 실패했는지 확인한다.
이를 통해 더욱 신뢰성 있는 메시지 전송을 할 수 있음

### 4.2.3 비동기 전송
비동기로 메시지를 발행하며 이때 콜백 등록이 가능하다.
응답을 기다리지 않기 때문에 더욱 빠른 전송이 가능하다.

### 4.3 프로듀서 활용 예제
- 키 옵션을 주지 않은면 라운드 로빈 방식으로 파티션마다 균등하게 메시지를 보낼 수 있다.
- 키값을 지정하면 항상 같은 파티션으로 메시지를 발행할 수 있다.
- 이때 장점은 순서 보장이 가장 대표적이다. 메시지의 순서를 보장하는것이 유리한 경우 같은 키를 갖도락 한다.

## 4.4 프로듀서 주요 옵션
- bootstrap.server
	- 카프카 클러스터는 클러스터 마스터라는 개념이 없기 떄문에 모든 서버가 클라이언트의 요청을 받을 수 있음 -> 리스트 전체를 입력하는 것을 권장
	- 포맷: 호스트 이름:포트, 호스트 이름:포트
- acks
	- 프로듀서가 브로커에게 메시지를 발행하고 acks 요청의 숫자
    - 0
        - 메시지를 보내고 acks를 기다리지 않음. 일종의 비동기 방식
        - 메시지가 안정적으로 브로커에게 도달했는지 프로듀서는 신경쓰지 않음
        - 당연히 재시도 없음
    - 1
        - 리더는 데이터를 기록하고 프로듀서에게 응답을 보냄
        - 팔로워가 데이터를 잘 복제했는지는 신경쓰지 않음
        - acks를 보내고 리더에 장애가 발생하면 메시지 손실 가능성 있음.
    - all (-1)
        - 리더는 데이터를 기록하고 모든 팔로워가 데이터를 복제한 후에 응답을 보냄
        - ISR = 2  / replication factor = 3 처럼 세팅하지 않으면 브로커 1대 다운시 클러스터 전체 장애로 이어짐
        - ISR = 3 / replication factor = 3인 경우 브로커 1대만 장애나도 acks를 못보내게 되고, 이 경우 retries로 이어짐.
- buffer.memory
	- 프로듀서의 메시지가 발행되기전에 잠시 머무르는 메모리 공간의 사이즈(배치 전송이나 딜레이가 있는 경우에 머무름)
- compression.type
	- 메시지 압축 포멧, gzip, snappy로 설정이 가능함 
- retries 
	- 전송 실패시 재시도하는 횟수
- batch.size
	- 이 사이즈보다 작은 배치 전송을 시도하고, 크면 배치 전송을 시도하지 않음.
- linger.ms
	- 프로듀서의 버퍼에 메시지가 머무르는 시간. 이 시간을 넘기면 buffer가 차지 않아도 전송이 됌. 또는 buffer가 차면 배치로 전송됌.
- max.request.size
	- 최대 메시지 바이트 사이즈
